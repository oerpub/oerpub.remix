<metal:use use-macro="base">

    <metal:script fill-slot="script-slot">

        <metal:m use-macro="editor.css" />
        
        <link rel="stylesheet"
            href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css"
            tal:attributes="href string:${request.application_url}/bootstrap/docs/assets/css/bootstrap.css" type="text/css">
            <!-- xhtml workaround -->
        </link>
        <link rel="stylesheet"
            href=""
            tal:attributes="href string:${request.application_url}/bootstrap/docs/assets/css/bootstrap-responsive.css" type="text/css">
            <!-- xhtml workaround -->
        </link>
        <link rel="stylesheet" type="text/css" 
            href="${request.application_url}/aloha/oerpub/css/bootstrap.css"> 
            <!-- xhtml workaround -->
        </link>
        
        <link rel="stylesheet" type="text/css" href="${request.static_url('oerpub.rhaptoslabs.swordpushweb:static/preview.css')}"> <!-- xhtml workaround --></link>

        <metal:m use-macro="editor.javascript" />
        <script type="text/javascript" src="${request.application_url}/aloha/src/lib/require.js">
            <!-- xhtml workaround -->
        </script>

        <script src="${request.application_url}/bootstrap/docs/assets/js/bootstrap.js"> 
            <!-- xhtml workaround -->
        </script>

        <script type="text/javascript">
            Aloha.ready(function(){
                Aloha.require(['PubSub'], function(PubSub){
                    $('#neworexisting').on('show', function(evt) {
                        if(Aloha.getEditableById('canvas').isModified()){
                            // show the info slider
                            $('#upload-wait').center().slideDown('slow');
                            $('#btn-newmodule').attr('disabled', 'disabled')
                                .removeClass('btn-primary');
                            $('#btn-existingmodule').attr('disabled', 'disabled')
                                .removeClass('btn-primary');
                            PubSub.pub('swordpushweb.save');
                        };
                    });
                    // Subscribe to the 'swordpushweb.save' event.
                    // It is fired by the the AlohaEditor when someone clicks
                    // the 'Save' button.
                    // Disable the navigation buttons.
                    PubSub.sub('swordpushweb.save', function(data) {
                        $('#btn-back').attr('disabled', 'disabled');
                        $('#show-neworexisting').attr('disabled', 'disabled');
                    });
                    // subscribe to the 'swordpusweb.saved' event. It is fired
                    // by the 'savePreview' function in the AlohaEditor.oerpub
                    // index.html page.
                    // Here we re-enable the navigation buttons.
                    PubSub.sub('swordpushweb.saved', function(data) {
                        var btn = $('#btn-back');
                        btn.removeAttr('disabled');

                        var btn = $('#show-neworexisting');
                        btn.removeAttr('disabled');

                        var btn = $('#btn-newmodule');
                        btn.removeAttr('disabled');
                        btn.addClass('btn-primary');
                        
                        var btn = $('#btn-existingmodule');
                        btn.removeAttr('disabled');
                        btn.addClass('btn-primary');

                        $('#upload-wait').slideUp('slow');
                    });
                });
                $('#neworexisting').on('hidden', function() {
                    // close the dbox while saving 
                    // which may mean the server is experiencing technical difficulties
                    $('#upload-wait').slideUp('slow');

                    var btn = $('#btn-newmodule');
                    $(btn).removeAttr('disabled');
                    $(btn).addClass('btn-primary');
                   
                    var btn = $('#btn-exsitingmodule');
                    $(btn).removeAttr('disabled');
                    $(btn).addClass('btn-primary');
                });
            });
        </script>
    </metal:script>

    <metal:workflownav fill-slot="workflownav">
    <span metal:use-macro="view.workflow_nav">workflow buttons
        <span metal:fill-slot="extras">
            <input name="workflownav.preview.submitted" type="hidden" value="submitted" />
            <input id="module" type="hidden" name="module_url"
                tal:attributes="value view.module_url|nothing">
        </span>
    </span>
    </metal:workflownav>

    <metal:content-slot fill-slot="content-slot"
        tal:define="filename python:request.session.get('filename')">
        <div id="ie6-container-wrap">
            <div id="container">
                <!-- ================= -->
                <!--  Toolbar Buttons  -->
                <!-- ================= -->
                <metal:m use-macro="editor.toolbar" />
                <div id="content">
                    <div id="artboard">
                        <div id="pageheader-wrap">
                            <div id="module-actions">
                                <div class="advanced" style="display: block;">
                                    <h2 class="advanced-label">
                                        Advanced
                                    </h2>
                                    <strong>Module actions: </strong>
                                    <a id="download-copy"
                                        title="Save a ZIP file containing the module's XML and metadata to your local computer."
                                        href="#asdfaasdf"
                                        tal:attributes="href request.route_url('download_zip')">
                                        <span class="button">Download a copy</span>
                                    </a>
                                    <a id="edit-xml"
                                        title="Make changes to the module by editing its XML code."
                                        href="${request.route_url('cnxml')}">
                                        <span class="button">Edit XML</span>
                                    </a>
                                </div>
                            </div>

                            <div id="page-title">
                                <h1>
                                    Preview:
                                    <span class="metatitle">
                                        Conversion of <span tal:content="filename">Filename</span>
                                    </span>
                                </h1>
                            </div>

                        </div>
                        <metal:m use-macro="editor.editor" />
                    </div>
                </div>
            </div>
        </div>

    <div class="pleasewait" id="upload-wait" style="display: none;">
        Your document is being saved. This may take a few moments.
    </div>
    </metal:content-slot>

    <metal:footer-slot fill-slot="footer-slot" />
</metal:use>
